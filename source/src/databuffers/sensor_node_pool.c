/**
 * @file  sensor_node_pool.c
 * @brief Sensor-Node-Pool
 *
 * @note
 * Copyright (C) 2017, Digitrol Ltd., Swansea, Wales. All rights reserved.
 */




/*******************************************************************************
*                               INCLUDE FILES
*******************************************************************************/
#include "sensor_node_pool.h"

#include "sensor_node_list.h"




/*******************************************************************************
*                               LOCAL DEFINES
*******************************************************************************/




/*******************************************************************************
*                               LOCAL CONSTANTS
*******************************************************************************/




/*******************************************************************************
*                               LOCAL DATA TYPES
*******************************************************************************/




/*******************************************************************************
*                               LOCAL TABLES
*******************************************************************************/




/*******************************************************************************
*                               LOCAL GLOBAL VARIABLES
*******************************************************************************/

static SensorNode *sp_found_node=NULL;




/*******************************************************************************
*                               LOCAL FUNCTION PROTOTYPES
*******************************************************************************/

bool compare_node__(uint32_t index, SensorNode const *p_node);




/*******************************************************************************
*                               LOCAL CONFIGURATION ERRORS
*******************************************************************************/




/*******************************************************************************
*                               GLOBAL FUNCTIONS
*******************************************************************************/

/******************************************************************************/
SensorNode* determine_which_node_should_send_data(SensorNode *p_current_node)
{
    SensorNode *p_next_node=NULL;

    if(
            ( SNL_is_in_list(p_current_node) ) &&
            ( p_current_node->is_used ) &&
            ( p_current_node->num_samples_waiting > 0U )
    )
    {
        /* stick with current node */
        p_next_node = p_current_node;
    }
    else
    {
        bool got_node=false;
        uint32_t num_attempts = SNL_get_size();

        SensorNode *p_iter = p_current_node;

        while( ( num_attempts > 0U ) && ( !got_node ) )
        {
            num_attempts--;

            p_iter = SNL_find_next_active_node(p_iter, true);

            if( p_iter == NULL )
            {
                /* failed to find another node */
                num_attempts = 0U;
            }
            else if( p_iter->num_samples_waiting > 0U )
            {
                p_next_node = p_iter;
                got_node = true;
            }
            else
            {
                /* do nothing here */
            }
        }
    }

    return p_next_node;
}
/******************************************************************************/




/*******************************************************************************
*                               LOCAL FUNCTIONS
*******************************************************************************/
